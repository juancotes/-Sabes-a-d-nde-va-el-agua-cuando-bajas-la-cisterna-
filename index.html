<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tipo de Alcantarillado en tu ubicaci√≥n (Bogot√°)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
  :root{
    --bg:#0b1020; --panel:#111a34; --muted:#7d8fb3;
    --ok:#17c964; --warn:#f5a524; --off:#94a3b8; --accent:#60a5fa;
    --danger:#ef4444; /* rojo para combinado y sin tratar */
  }
  html,body{height:100%;margin:0;background:var(--bg);color:#e5ecff;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";}
  #app{display:grid;grid-template-rows:auto 1fr;height:100%}
  header{padding:12px clamp(12px,3vw,24px);display:grid;gap:10px;grid-template-columns:1fr auto auto;align-items:center;background:linear-gradient(180deg,#0b142b 0%,#0b1020 100%);border-bottom:1px solid #1e2a4a}
  header h1{margin:0;font-size:clamp(16px,2.2vw,20px);font-weight:600;letter-spacing:.2px;color:#f0f6ff}
  .controls{display:flex;gap:8px;align-items:center;justify-self:end}
  .controls input{width:min(48vw,520px);padding:10px 12px;border-radius:12px;border:1px solid #1e2a4a;background:#0f1a33;color:#e5ecff;outline:none}
  .controls button{padding:10px 14px;border-radius:12px;border:1px solid #1e2a4a;background:#0f1f3f;color:#e5ecff;cursor:pointer}
  .controls button:hover{filter:brightness(1.1)}
  .hint{font-size:12px;color:var(--muted);grid-column:1/-1;margin-top:-6px}
  #map{width:100%;height:100%}
  .panel{position:absolute;top:90px;right:10px;z-index:999;background:var(--panel);border:1px solid #1e2a4a;border-radius:16px;padding:14px;width:min(92vw,360px);box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .panel h2{margin:0 0 8px;font-size:16px;font-weight:600}
  .badge{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:10px;font-weight:600;margin-bottom:6px}
  .ok{background:rgba(23,201,100,.12);color:var(--ok);border:1px solid rgba(23,201,100,.3)}
  .warn{background:rgba(245,165,36,.12);color:var(--warn);border:1px solid rgba(245,165,36,.3)} /* amarillo */
  .danger{background:rgba(239,68,68,.12);color:var(--danger);border:1px solid rgba(239,68,68,.35)} /* rojo */
  .off{background:rgba(148,163,184,.12);color:var(--off);border:1px solid rgba(148,163,184,.3)}
  .panel .kv{margin:8px 0;font-size:13px;color:#c7d2fe}
  .panel .kv span{color:var(--muted)}
  .panel .small{margin-top:8px;font-size:12px;color:var(--muted)}
  .loading{color:var(--accent);font-size:13px}
  .leaflet-container{background:#0b1020;outline:none}
  .loc-pin{filter:drop-shadow(0 3px 6px rgba(0,0,0,.45))}
  /* Modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(5,8,18,.65);display:none;align-items:center;justify-content:center;z-index:2000}
  .modal{background:#0f1a33;border:1px solid #22325c;border-radius:16px;width:min(92vw,720px);padding:18px;box-shadow:0 20px 60px rgba(0,0,0,.5)}
  .modal h3{margin:0 0 8px;font-size:18px}
  .modal p{margin:8px 0;color:#d9e2ff}
  .modal .tip{font-size:13px;color:var(--muted)}
  .modal .actions{display:flex;gap:8px;justify-content:end;margin-top:12px}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid #1e2a4a;background:#0f1f3f;color:#e5ecff;cursor:pointer}
  .btn.primary{background:#173164;border-color:#2950a3}
  @media (max-width:720px){
    header{grid-template-columns:1fr}
    .controls{justify-self:stretch;flex-wrap:wrap}
    .controls input{flex:1 1 100%;width:100%}
    .panel{position:fixed;inset:auto 8px 8px 8px;top:auto}
  }
</style>
</head>
<body>
<div id="app">
  <header>
    <h1>Alcantarillado en tu punto (Bogot√°)</h1>
    <div class="controls">
      <input id="address" type="text" placeholder="Escribe una direcci√≥n en Bogot√° (ej. 'Cll 72 #10-34, Bogot√°')" />
      <button id="searchBtn" title="Buscar por direcci√≥n">Buscar</button>
      <button id="locBtn" title="Usar mi ubicaci√≥n">Usar mi ubicaci√≥n</button>
    </div>
    <div class="hint">Tambi√©n puedes <strong>hacer clic en el mapa</strong> para evaluar ese punto.</div>
  </header>

  <div id="map"></div>

  <div class="panel" id="infoPanel" aria-live="polite">
    <h2>Estado</h2>
    <div id="statusRow" class="badge off">Esperando un punto‚Ä¶</div>
    <!-- Mensaje tratamiento -->
    <div id="tratamientoRow" class="badge off" style="display:none;"></div>
    <div class="kv"><span>Cuenca:</span> <strong id="cuencaVal">‚Äî</strong></div>
    <div class="kv"><span>Tipo de sistema:</span> <strong id="tipoVal">‚Äî</strong></div>
    <div class="kv"><span>Coordenadas:</span> <strong id="coordsVal">‚Äî</strong></div>
    <div class="small">Fuente: <code>ACUEDUCTO_SERVICIOS/AlcantarilladoSanitario</code>. ‚ÄúSin datos‚Äù suele indicar que el punto est√° fuera de Bogot√° o fuera de cobertura de la capa.</div>
  </div>
</div>

<!-- Modal (Mensaje inicial nuevo) -->
<div class="modal-backdrop" id="welcomeBackdrop" aria-modal="true" role="dialog">
  <div class="modal" role="document">
    <h3>üöΩ ¬øSabes a d√≥nde va el agua cuando bajas la cisterna?</h3>
    <p>Busca una direcci√≥n o <strong>selecciona un punto en el mapa</strong>. Descubre si las aguas residuales se mezclan con el agua lluvia y si es o no probable que sean tratadas antes de llegar al r√≠o Bogot√°.</p>
    <p class="tip">Privacidad: si usas ‚ÄúUsar mi ubicaci√≥n‚Äù, tu posici√≥n solo se usa en tu navegador para consultar los servicios p√∫blicos.</p>
    <div class="actions">
      <button class="btn" id="laterBtn">Cerrar</button>
      <button class="btn primary" id="startBtn">Entendido</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
(function(){
  const MAPSERVER = "https://www.acueducto.com.co/sigueserverpublish/rest/services/ACUEDUCTO_SERVICIOS/AlcantarilladoSanitario/MapServer";

  const map = L.map('map', { zoomControl:true, attributionControl:true }).setView([4.65,-74.1], 12);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {maxZoom:19, attribution:'&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'}).addTo(map);

  let marker = L.marker([0,0], { draggable:false, opacity:0, className:'loc-pin' }).addTo(map);

  const addressInput = document.getElementById('address');
  const searchBtn = document.getElementById('searchBtn');
  const locBtn = document.getElementById('locBtn');
  const statusRow = document.getElementById('statusRow');
  const cuencaVal = document.getElementById('cuencaVal');
  const tipoVal = document.getElementById('tipoVal');
  const coordsVal = document.getElementById('coordsVal');
  const tratamientoRow = document.getElementById('tratamientoRow');

  const backdrop = document.getElementById('welcomeBackdrop');
  const startBtn = document.getElementById('startBtn');
  const laterBtn = document.getElementById('laterBtn');
  function showWelcome(){ backdrop.style.display='flex'; }
  function hideWelcome(){ backdrop.style.display='none'; }
  startBtn.addEventListener('click', hideWelcome);
  laterBtn.addEventListener('click', hideWelcome);
  window.addEventListener('load', showWelcome);

  function setStatus(type,text){
    statusRow.className='badge '+type;
    statusRow.textContent=text;
  }
  function setLoading(on){
    if(on){ setStatus('off','Consultando‚Ä¶'); statusRow.classList.add('loading'); }
    else { statusRow.classList.remove('loading'); }
  }

  // Tratamiento: si cuenca incluye 'Salitre' -> PROBABLE TRATAMIENTO (amarillo);
  // si cuenca conocida distinta -> SIN TRATAR (rojo);
  // si cuenca desconocida -> mensaje neutro.
  function setTratamientoMessage(cuenca){
    const raw = (cuenca||'').toString().trim();
    tratamientoRow.style.display='inline-flex';
    if(!raw){
      tratamientoRow.className='badge off';
      tratamientoRow.textContent='No se pudo determinar la cuenca para estimar tratamiento.';
      return;
    }
    const c = raw.toLowerCase();
    if(c.includes('salitre')){
      tratamientoRow.className='badge warn'; // amarillo
      tratamientoRow.textContent='Es probable que tu agua sea tratada antes de llegar al r√≠o Bogot√°.';
    } else {
      tratamientoRow.className='badge danger'; // rojo
      tratamientoRow.textContent='Tu agua llega sin tratar al r√≠o Bogot√°.';
    }
  }

  function updateInfo({lat,lon,tipo,cuenca}){
    coordsVal.textContent = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
    tipoVal.textContent = tipo ?? '‚Äî';
    cuencaVal.textContent = cuenca ?? '‚Äî';
    setTratamientoMessage(cuenca);

    const norm = (tipo||'').toString().trim().toLowerCase();

    if(!tipo){
      setStatus('off','Sin datos en este punto');
    } else if(norm==='sanitario'){
      // S√ç hay separaci√≥n (texto nuevo)
      setStatus('ok','üö∞ En tu sector el alcantarillado es separado: las aguas residuales viajan por una red distinta a la de las aguas lluvias, lo que facilita su tratamiento antes de llegar al r√≠o.');
    } else if(norm==='combinado'){
      // NO hay separaci√≥n (texto nuevo) en ROJO
      setStatus('danger','üíß En tu sector el alcantarillado es combinado: las aguas residuales se mezclan con las aguas lluvias y viajan juntas por la misma red.');
    } else {
      setStatus('off',`Tipo desconocido: ${tipo}`);
    }
  }

  async function geocodeAddress(query){
    const q = /bogot[a√°]/i.test(query) ? query : `${query}, Bogot√°, Colombia`;
    const url = new URL('https://nominatim.openstreetmap.org/search');
    url.searchParams.set('format','jsonv2'); url.searchParams.set('limit','1'); url.searchParams.set('addressdetails','1'); url.searchParams.set('q',q);
    const res = await fetch(url.toString(), { headers:{'Accept-Language':'es','User-Agent':'alcantarillado-bogota-demo/1.0'}});
    if(!res.ok) throw new Error('Error en geocodificaci√≥n');
    const data = await res.json();
    if(!Array.isArray(data) || data.length===0) throw new Error('Direcci√≥n no encontrada');
    const {lat,lon} = data[0];
    return {lat:parseFloat(lat), lon:parseFloat(lon)};
  }

  // IDENTIFY robusto: detecta TipoSistema y mejor "cuenca"
  async function identifyTipo(lat, lon){
    const bounds = map.getBounds();
    const mapExtent = [bounds.getWest(), bounds.getSouth(), bounds.getEast(), bounds.getNorth()].join(',');
    const mapDiv = document.getElementById('map');
    const w = mapDiv.clientWidth || 800, h = mapDiv.clientHeight || 600;

    const identifyUrl = new URL(MAPSERVER + '/identify');
    const geometry = JSON.stringify({ x: lon, y: lat, spatialReference: { wkid: 4326 } });
    const params = { f:'json', tolerance:'5', returnGeometry:'false', mapExtent, imageDisplay:`${w},${h},96`, geometry, geometryType:'esriGeometryPoint', sr:'4326', layers:'all' };
    Object.entries(params).forEach(([k,v])=>identifyUrl.searchParams.set(k,v));

    const res = await fetch(identifyUrl.toString());
    if(!res.ok) throw new Error('No se pudo consultar el servicio');
    const json = await res.json();
    if(!json || !Array.isArray(json.results) || json.results.length===0) return { tipo:null, cuenca:null };

    let tipo = null, tipoLayer = null, tipoScore = -1;
    const cuencaCandidates = []; // {value, score}

    const clean = s => (s??'').toString().trim();
    const isTipoVal = v => /^(sanitario|combinado)$/i.test(clean(v));

    for(const r of json.results){
      const attrs = r.attributes || {};
      const keys = Object.keys(attrs);
      const ln = (r.layerName||'').toLowerCase();

      const tipoKey =
        keys.find(k => k.toLowerCase().replace(/[^a-z]/g,'')==='tiposistema') ||
        keys.find(k => k.toLowerCase().includes('tiposistema')) ||
        keys.find(k => k.toLowerCase()==='tipo' && isTipoVal(attrs[k])) ||
        keys.find(k => k.toLowerCase().includes('sistema') && isTipoVal(attrs[k]));

      if(tipoKey && isTipoVal(attrs[tipoKey])){
        const score = (ln.includes('alcantarillado')||ln.includes('sanitari')?3:0) + (ln.includes('red')||ln.includes('sistema')?1:0);
        if(score > tipoScore){
          tipoScore = score;
          tipo = clean(attrs[tipoKey]);
          tipoLayer = r;
        }
      }

      const cKey = keys.find(k => /cuenca|subcuenca|microcuenca/i.test(k));
      if(cKey){
        const val = clean(attrs[cKey]);
        const lower = val.toLowerCase();
        if(val){
          let cScore = 0;
          if(ln.includes('cuenca')) cScore += 3;
          if(/salitre|fucha|tunju|torca|jaboque|teusac|juan amarillo|bogot/.test(lower)) cScore += 2;
          if(/^no$|^n\/a$|^sin dato$|^s\/d$/i.test(lower) || /^\d+$/.test(lower)) cScore -= 5;
          cuencaCandidates.push({ value: val, score: cScore, ln });
        }
      }
    }

    let cuenca = null;
    if(tipoLayer){
      const attrs = tipoLayer.attributes || {};
      const k = Object.keys(attrs).find(k=>/cuenca|subcuenca|microcuenca/i.test(k));
      const val = k ? clean(attrs[k]) : '';
      if(val && !/^no$|^n\/a$|^sin dato$|^s\/d$/i.test(val) && !/^\d+$/.test(val)) cuenca = val;
    }

    if(!cuenca && cuencaCandidates.length){
      cuencaCandidates.sort((a,b)=>b.score - a.score);
      if(cuencaCandidates[0].score >= 1) cuenca = cuencaCandidates[0].value;
    }

    return { tipo: tipo ?? null, cuenca: cuenca ?? null };
  }

  async function evaluatePoint(lat, lon, panZoom=true){
    try{
      setLoading(true);
      if(panZoom){ map.setView([lat,lon], Math.max(map.getZoom(),15)); }
      marker.setLatLng([lat,lon]).setOpacity(1);
      const { tipo, cuenca } = await identifyTipo(lat, lon);
      updateInfo({ lat, lon, tipo, cuenca });
    }catch(err){
      console.error(err);
      setStatus('off','Error al evaluar el punto');
      tipoVal.textContent='‚Äî';
      cuencaVal.textContent='‚Äî';
      tratamientoRow.style.display='inline-flex';
      tratamientoRow.className='badge off';
      tratamientoRow.textContent='No se pudo determinar la cuenca para estimar tratamiento.';
    }finally{ setLoading(false); }
  }

  searchBtn.addEventListener('click', async ()=>{
    const q = addressInput.value.trim();
    if(!q){ addressInput.focus(); return; }
    try{
      setLoading(true);
      const { lat, lon } = await geocodeAddress(q);
      coordsVal.textContent = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
      await evaluatePoint(lat, lon, true);
    }catch(e){
      console.error(e);
      setLoading(false);
      setStatus('off','No se pudo encontrar esa direcci√≥n');
      tratamientoRow.style.display='inline-flex';
      tratamientoRow.className='badge off';
      tratamientoRow.textContent='No se pudo determinar la cuenca para estimar tratamiento.';
    }
  });

  addressInput.addEventListener('keydown', e=>{
    if(e.key==='Enter'){ e.preventDefault(); searchBtn.click(); }
  });

  locBtn.addEventListener('click', ()=>{
    if(!('geolocation' in navigator)){ setStatus('off','Tu navegador no permite geolocalizaci√≥n'); return; }
    setLoading(true);
    navigator.geolocation.getCurrentPosition(
      async pos=>{
        const lat=pos.coords.latitude, lon=pos.coords.longitude;
        coordsVal.textContent = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
        await evaluatePoint(lat, lon, true);
      },
      err=>{
        console.error(err);
        setLoading(false);
        setStatus('off','No se pudo obtener tu ubicaci√≥n');
        tratamientoRow.style.display='inline-flex';
        tratamientoRow.className='badge off';
        tratamientoRow.textContent='No se pudo determinar la cuenca para estimar tratamiento.';
      },
      { enableHighAccuracy:true, timeout:10000, maximumAge:0 }
    );
  });

  map.on('click', e=>{
    const { lat, lng } = e.latlng;
    coordsVal.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    evaluatePoint(lat, lng, false);
  });

  setStatus('off','Esperando un punto‚Ä¶');
})();
</script>
</body>
</html>
